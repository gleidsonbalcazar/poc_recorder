<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">

  <!-- Product Definition -->
  <Product Id="*"
           Name="!(loc.ProductName)"
           Language="!(loc.LCID)"
           Version="1.0.0.0"
           Manufacturer="!(loc.Manufacturer)"
           UpgradeCode="A1B2C3D4-E5F6-4A5B-9C8D-7E6F5A4B3C2D">

    <!-- Package Information -->
    <Package InstallerVersion="500"
             Compressed="yes"
             InstallScope="perMachine"
             Description="!(loc.ProductDescription)"
             Comments="Paneas C2 Agent - Remote Monitoring and Control System"
             Manufacturer="!(loc.Manufacturer)" />

    <!-- Media - Single CAB embedded in MSI -->
    <MediaTemplate EmbedCab="yes" CompressionLevel="high" />

    <!-- Major Upgrade - Uninstall old version before installing new -->
    <MajorUpgrade DowngradeErrorMessage="!(loc.DowngradeError)"
                  AllowSameVersionUpgrades="yes" />

    <!-- Icons -->
    <Icon Id="ProductIcon" SourceFile="$(var.ProjectDir)\..\Agent\icon.ico" />
    <Property Id="ARPPRODUCTICON" Value="ProductIcon" />

    <!-- Add/Remove Programs Properties -->
    <Property Id="ARPURLINFOABOUT" Value="https://github.com/gleidsonbalcazar/poc_recorder" />
    <Property Id="ARPNOREPAIR" Value="yes" Secure="yes" />
    <Property Id="ARPNOMODIFY" Value="yes" Secure="yes" />

    <!-- Installation Directory -->
    <Property Id="INSTALLFOLDER">
      <RegistrySearch Id="FindInstallLocation"
                      Root="HKLM"
                      Key="Software\PaneasMonitor"
                      Name="InstallLocation"
                      Type="raw" />
    </Property>

    <!-- Configuration Properties (User-Configurable) -->
    <Property Id="C2_SERVER_URL" Value="http://localhost:8000" />
    <Property Id="UPLOAD_ENABLED" Value="false" />
    <Property Id="UPLOAD_ENDPOINT" Value="" />
    <Property Id="TUS_SERVER_URL" Value="" />
    <Property Id="OPERATION_MODE" Value="hybrid" />

    <!-- Directory Structure -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <!-- Program Files -->
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="CompanyFolder" Name="Paneas Monitor">
          <Directory Id="INSTALLFOLDER" Name="Agent">
            <Directory Id="BinFolder" Name="bin" />
            <Directory Id="FFmpegFolder" Name="ffmpeg" />
          </Directory>
        </Directory>
      </Directory>

      <!-- ProgramData (for logs, videos, database) -->
      <Directory Id="CommonAppDataFolder">
        <Directory Id="PaneasDataFolder" Name="C2Agent">
          <Directory Id="BinDataFolder" Name="bin" />
          <Directory Id="LogsFolder" Name="Logs" />
          <Directory Id="VideosFolder" Name="Videos" />
        </Directory>
      </Directory>

      <!-- Start Menu -->
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="Paneas Monitor" />
      </Directory>
    </Directory>

    <!-- Feature: Main Installation -->
    <Feature Id="ProductFeature"
             Title="!(loc.FeatureMainTitle)"
             Description="!(loc.FeatureMainDescription)"
             Level="1"
             ConfigurableDirectory="INSTALLFOLDER"
             AllowAdvertise="no"
             Display="expand">

      <!-- Agent Components -->
      <ComponentGroupRef Id="AgentComponents" />
      <ComponentGroupRef Id="FFmpegComponents" />
      <ComponentGroupRef Id="ConfigurationComponents" />
      <ComponentGroupRef Id="DataFolderComponents" />

      <!-- Service Installation -->
      <ComponentGroupRef Id="ServiceComponents" />

      <!-- Task Scheduler -->
      <ComponentGroupRef Id="TaskSchedulerComponents" />

      <!-- Start Menu Shortcuts -->
      <ComponentGroupRef Id="ShortcutComponents" />
    </Feature>

    <!-- Custom Actions -->
    <CustomAction Id="WriteConfiguration"
                  BinaryKey="CustomActionsDLL"
                  DllEntry="WriteConfigurationCA"
                  Execute="deferred"
                  Impersonate="no"
                  Return="check" />

    <CustomAction Id="SetConfigParams"
                  Property="WriteConfiguration"
                  Value="INSTALLFOLDER=[INSTALLFOLDER];C2_SERVER_URL=[C2_SERVER_URL];UPLOAD_ENABLED=[UPLOAD_ENABLED];UPLOAD_ENDPOINT=[UPLOAD_ENDPOINT];TUS_SERVER_URL=[TUS_SERVER_URL];OPERATION_MODE=[OPERATION_MODE]" />

    <!-- Installation Sequence -->
    <InstallExecuteSequence>
      <!-- Write configuration after files are installed -->
      <Custom Action="SetConfigParams" Before="WriteConfiguration">NOT Installed</Custom>
      <Custom Action="WriteConfiguration" After="InstallFiles">NOT Installed</Custom>
    </InstallExecuteSequence>

    <!-- UI Configuration -->
    <UIRef Id="WixUI_FeatureTree" />
    <UIRef Id="WixUI_ErrorProgressText" />

    <!-- Custom Configuration Dialog -->
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />

    <!-- License Agreement -->
    <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />

    <!-- Banner Images -->
    <WixVariable Id="WixUIBannerBmp" Value="banner.bmp" />
    <WixVariable Id="WixUIDialogBmp" Value="dialog.bmp" />

  </Product>

  <!-- Component Groups will be defined in separate files -->

</Wix>
