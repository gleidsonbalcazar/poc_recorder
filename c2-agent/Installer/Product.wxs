<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">

  <!-- Package Definition -->
  <Package Name="!(loc.ProductName)"
           Language="!(loc.LCID)"
           Version="$(var.ProductVersion)"
           Manufacturer="!(loc.Manufacturer)"
           UpgradeCode="A1B2C3D4-E5F6-4A5B-9C8D-7E6F5A4B3C2D"
           InstallerVersion="500"
           Compressed="yes"
           Scope="perMachine">

    <!-- Media - Single CAB embedded in MSI -->
    <MediaTemplate EmbedCab="yes" CompressionLevel="high" />

    <!-- Major Upgrade - Uninstall old version before installing new -->
    <MajorUpgrade DowngradeErrorMessage="!(loc.DowngradeError)"
                  AllowSameVersionUpgrades="yes" />

    <!-- Icons -->
    <!-- TODO: Create icon.ico file -->
    <!-- <Icon Id="ProductIcon" SourceFile="$(var.ProjectDir)\..\Agent\icon.ico" /> -->
    <!-- <Property Id="ARPPRODUCTICON" Value="ProductIcon" /> -->

    <!-- Add/Remove Programs Properties -->
    <Property Id="ARPURLINFOABOUT" Value="https://github.com/gleidsonbalcazar/poc_recorder" />
    <Property Id="ARPNOREPAIR" Value="yes" Secure="yes" />
    <Property Id="ARPNOMODIFY" Value="yes" Secure="yes" />

    <!-- Installation Directory -->
    <Property Id="INSTALLFOLDER">
      <RegistrySearch Id="FindInstallLocation"
                      Root="HKLM"
                      Key="Software\PaneasMonitor"
                      Name="InstallLocation"
                      Type="raw" />
    </Property>

    <!-- Configuration Properties (User-Configurable) -->
    <Property Id="C2_SERVER_URL" Value="http://localhost:8000" />
    <Property Id="UPLOAD_ENABLED" Value="false" />
    <Property Id="UPLOAD_ENDPOINT" />
    <Property Id="TUS_SERVER_URL" />
    <Property Id="OPERATION_MODE" Value="hybrid" />

    <!-- Directory Structure -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <!-- Program Files -->
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="CompanyFolder" Name="Paneas Monitor">
          <Directory Id="INSTALLFOLDER" Name="Agent">
            <Directory Id="BinFolder" Name="bin" />
            <Directory Id="FFmpegFolder" Name="ffmpeg" />
          </Directory>
        </Directory>
      </Directory>

      <!-- ProgramData (for Service logs) -->
      <Directory Id="CommonAppDataFolder">
        <Directory Id="PaneasMonitorDataFolder" Name="PaneasMonitor">
          <Directory Id="ServiceDataFolder" Name="Service">
            <Directory Id="ServiceLogsFolder" Name="logs" />
          </Directory>
        </Directory>
      </Directory>

      <!-- Start Menu -->
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="Paneas Monitor" />
      </Directory>
    </Directory>

    <!-- Feature: Main Installation -->
    <Feature Id="ProductFeature"
             Title="!(loc.FeatureMainTitle)"
             Description="!(loc.FeatureMainDescription)"
             Level="1"
             ConfigurableDirectory="INSTALLFOLDER"
             AllowAdvertise="no"
             Display="expand">

      <!-- Agent Components -->
      <ComponentGroupRef Id="AgentComponents" />
      <ComponentGroupRef Id="FFmpegComponents" />

      <!-- Service Installation -->
      <ComponentGroupRef Id="ServiceComponents" />
      <ComponentGroupRef Id="FirewallComponents" />
      <ComponentGroupRef Id="ServiceFolderComponents" />
      <ComponentGroupRef Id="InstallLocationRegistry" />

      <!-- Task Scheduler -->
      <ComponentGroupRef Id="TaskSchedulerComponents" />

      <!-- Start Menu Shortcuts -->
      <ComponentGroupRef Id="ShortcutComponents" />
    </Feature>

    <!-- Custom Actions -->
    <!-- TODO: Implement CustomAction DLL to write appsettings.json configuration -->

    <!-- Installation Sequence -->
    <InstallExecuteSequence>
      <!-- Configuration will be written by CustomAction DLL in future version -->
    </InstallExecuteSequence>

    <!-- UI Configuration -->
    <!-- TODO: WiX v4 UI implementation needs research - basic MSI without custom UI for now -->

  </Package>

  <!-- Component Groups will be defined in separate files -->

</Wix>
