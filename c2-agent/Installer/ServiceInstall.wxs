<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">

  <Fragment>
    <!-- Windows Service Components -->
    <ComponentGroup Id="ServiceComponents" Directory="BinFolder">

      <!-- PaneasMonitorService.exe -->
      <Component Id="ServiceExecutable" Guid="F1A2B3C4-D5E6-4F7A-8B9C-0D1E2F3A4B5C">

        <!-- Service Executable File -->
        <File Id="PaneasMonitorService.exe"
              Name="PaneasMonitorService.exe"
              Source="$(var.ProjectDir)\..\PaneasMonitorService\bin\Release\net8.0\win-x64\publish\PaneasMonitorService.exe"
              KeyPath="yes" />

        <!-- Install Windows Service -->
        <ServiceInstall Id="InstallPaneasMonitorService"
                        Name="PaneasMonitorService"
                        DisplayName="!(loc.ServiceDisplayName)"
                        Description="!(loc.ServiceDescription)"
                        Type="ownProcess"
                        Start="auto"
                        ErrorControl="normal"
                        Arguments=""
                        Account="LocalSystem"
                        Interactive="no" />

        <!-- Service Control (Start/Stop) -->
        <ServiceControl Id="StartPaneasMonitorService"
                        Name="PaneasMonitorService"
                        Start="install"
                        Stop="both"
                        Remove="uninstall"
                        Wait="yes" />

        <!-- Service Dependencies -->
        <util:ServiceConfig ServiceName="PaneasMonitorService"
                           FirstFailureActionType="restart"
                           SecondFailureActionType="restart"
                           ThirdFailureActionType="restart"
                           RestartServiceDelayInSeconds="60" />

      </Component>

      <!-- Service Configuration File -->
      <Component Id="ServiceConfig" Guid="A2B3C4D5-E6F7-4A8B-9C0D-1E2F3A4B5C6D">
        <File Id="ServiceAppsettings"
              Name="appsettings.json"
              Source="$(var.ProjectDir)\..\PaneasMonitorService\appsettings.json"
              KeyPath="yes" />
      </Component>

    </ComponentGroup>

    <!-- Firewall Rules (optional) -->
    <Fragment>
      <ComponentGroup Id="FirewallComponents" Directory="BinFolder">

        <!-- Allow inbound HTTP on port 9000 for media preview -->
        <Component Id="FirewallRule" Guid="B3C4D5E6-F7A8-4B9C-0D1E-2F3A4B5C6D7E">
          <util:FirewallException Id="AllowMediaServer"
                                 Name="Paneas Monitor - Media Server"
                                 Description="!(loc.FirewallRuleDescription)"
                                 Port="9000"
                                 Protocol="tcp"
                                 Scope="localSubnet"
                                 IgnoreFailure="yes" />
          <RegistryValue Root="HKLM" Key="Software\PaneasMonitor\Firewall" Name="MediaServerRule"
                         Type="integer" Value="1" KeyPath="yes" />
        </Component>

      </ComponentGroup>
    </Fragment>

  </Fragment>

</Wix>
